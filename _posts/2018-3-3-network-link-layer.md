---
layout: post
title:  "关于网络层和数据链路层"
tag:
- 计算机网络
comments: true
---

## IP地址和MAC地址

关于IP地址和MAC地址的定义就不赘述了，直接说一下两者各自在网络通信中的应用背景：

- IP地址主要在网络层（Network Layer）中被使用：网络层实现主机之间的通信，包括规划好目的地地址等。
- MAC地址主要在数据链路层（Data Link Layer）中被使用：网络层只是规划了目的地，具体怎么走则要靠数据链路层，所以数据链路层负责实现具体链路的通信，这就要依赖MAC地址来指示了。

有一张图清晰地描述了两者的应用过程：

![](https://controny.github.io/assets/images/posts/20180302153645.png)

可见，
- 在通信过程中，IP源地址和目的地址都是始终不变的（除非使用NAT将私有地址转换为公网地址），这也是我之前未能正确理解的，我一直以为IP目的地址在路由转发过程中会不断变化为下一个路由器的地址。
- 而MAC目的地址才是一直变化的，它会不断地更新为下一个到达位置（路由器或主机）的地址。

## 交换机和路由器

- 交换机主要工作在数据链路层，能识别MAC地址，根据MAC地址转发链路层数据帧，用于**同一网络内部**数据的快速传输。
- 路由器位于网络层，能识别IP地址并根据其网段（注意不是整个IP地址）转发分组，用于**不同网络间**数据的跨网络传输。

## ARP协议

ARP即Address Resolution Protocol，用于将目标主机的IP地址映射为其MAC地址，具体步骤看图就可以了：

![](https://controny.github.io/assets/images/posts/20180302155035.png)

## 综合应用实例

摘自[某博客](http://blog.51cto.com/dengqi/1223132)：

![](https://controny.github.io/assets/images/posts/20180302165113.png)

1. HostA在网络层将来自上层的报文封装成IP数据包，其中源IP地址为自己，目标IP地址是HostB，HostA会用本机配置的24位子网掩码与目标地址进行“与”运算，得出目标地址与本机不是同一网段，因此发送HostB的数据包需要经过网关路由A的转发。

2. HostA通过ARP请求获取网关路由A的E0口的MAC地址，并在链路层将路由器E0接口的MAC地址封装成目标MAC地址，源MAC地址是自己。

3. 路由器A从E0可接收到数据帧，把数据链路层的封装去掉，并检查路由表中是否有目标IP地址网段(即192.168.2.2的网段)相匹配的的项，根据路由表中记录到192.168.2.0网段的数据请发送给下一跳地址10.1.1.2，因此数据在路由器A的E1口重新封装，此时，源MAC地址是路由器A的E1接口的MAC地址，封装的目标MAC地址则是路由器2的E1接口的MAC地址。

4. 路由B从E1口接收到数据帧，同样会把数据链路层的封装去掉，对目标IP地址进行检测，并与路由表进行匹配，此时发现目标地址的网段正好是自己E0口的直连网段，路由器B通过ARP广播，获知HostB的MAC地址，此时数据包在路由器B的E0接口再次封装，源MAC地址是路由器B的E0接口的MAC地址，目标MAC地址是HostB的MAC地址。封装完成后直接从路由器的E0接口发送给HostB。

5. 此时HostB才会收到来自HostA发送的数据。

